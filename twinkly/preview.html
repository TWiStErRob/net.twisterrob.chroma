<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>My first three.js app</title>
	<style>
		body {
			overflow: hidden;
			margin: 0;
		}
	</style>
</head>
<body>
<script type="importmap">
	{
		"imports": {
			"three": "https://unpkg.com/three@0.160.0/build/three.module.js",
			"three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
		}
	}
</script>

<script type="module">
	import * as THREE from 'three';

	THREE.ColorManagement.legacyMode = false;

	import { GUI } from 'three/addons/libs/lil-gui.module.min.js';

	import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
	import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
	import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
	import { ShaderPass } from 'three/addons/postprocessing/ShaderPass.js';
	import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
	import { GammaCorrectionShader } from 'three/addons/shaders/GammaCorrectionShader.js';

	class Main {
		params = {
			threshold: 0,
			strength: 1,
			radius: 0,
			exposure: 1,
		};

		init() {
			const renderer = new THREE.WebGLRenderer({ antialias: true });
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.toneMapping = THREE.ACESFilmicToneMapping;
			renderer.outputColorSpace = THREE.SRGBColorSpace;
			document.body.appendChild(renderer.domElement);
			this.renderer = renderer;

			this.camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 0.01, 200);

			const controls = new OrbitControls(this.camera, renderer.domElement);
			controls.object.position.set(0, 1, 2);
			controls.target = new THREE.Vector3(0, 1, 0);
			controls.minDistance = 1;
			controls.maxDistance = 10;
			controls.addEventListener('change', () => this.render());

			const scene = new THREE.Scene();
			setupScene(scene);
			this.scene = scene;

			const bloomPass = new UnrealBloomPass();
			bloomPass.threshold = this.params.threshold;
			bloomPass.strength = this.params.strength;
			bloomPass.radius = this.params.radius;
			this.bloomPass = bloomPass;

			const target = new THREE.WebGLRenderTarget(window.innerWidth, window.innerHeight, {
				type: THREE.HalfFloatType,
				format: THREE.RGBAFormat,
				colorSpace: THREE.SRGBColorSpace,
				samples: 8,
			});
			const composer = new EffectComposer(renderer, target);
			composer.addPass(new RenderPass(scene, this.camera));
			composer.addPass(new ShaderPass(GammaCorrectionShader));
			composer.addPass(bloomPass);
			this.composer = composer;

			this.setupGui();
		}

		setupGui() {
			const gui = new GUI();

			const bloomFolder = gui.addFolder('bloom');

			const that = this;
			bloomFolder.add(this.params, 'threshold', 0.0, 1.0).onChange(function(value) {
				that.bloomPass.threshold = Number(value);
				that.render();
			});

			bloomFolder.add(this.params, 'strength', 0.0, 3).onChange(function(value) {
				that.bloomPass.strength = Number(value);
				that.render();
			});

			bloomFolder.add(this.params, 'radius', 0.0, 1.0).step(0.01).onChange(function(value) {
				that.bloomPass.radius = Number(value);
				that.render();
			});

			const toneMappingFolder = gui.addFolder('tone mapping');

			toneMappingFolder.add(this.params, 'exposure', 0.1, 2).onChange(function(value) {
				that.renderer.toneMappingExposure = Math.pow(value, 4.0);
				that.render();
			});
		}

		onPointerDown(event) {
			const mouse = new THREE.Vector2(
				(event.clientX / window.innerWidth) * 2 - 1,
				-(event.clientY / window.innerHeight) * 2 + 1,
			);

			const raycaster = new THREE.Raycaster();
			raycaster.setFromCamera(mouse, this.camera);
			const intersects = raycaster.intersectObjects(this.scene.children, false);
			if (intersects.length > 0) {
				/** @type {Bulb} */
				const object = intersects[0].object.domain;
				object.bloom(!object.bloom);
				this.render();
			}
		}

		onResize() {
			const width = window.innerWidth;
			const height = window.innerHeight;

			this.camera.aspect = width / height;
			this.camera.updateProjectionMatrix();

			this.renderer.setSize(width, height);
			this.composer.setSize(width, height);
			this.render();
		}

		render() {
			this.composer.render();
		}
	}

	class Bulb {
		static geometry = new THREE.SphereGeometry(0.015);

		constructor(position) {
			const color = new THREE.Color();
			color.setHSL(Math.random(), 0.7, Math.random() * 0.2 + 0.05);

			this.material = new THREE.MeshBasicMaterial({ color: color });
			this.sphere = new THREE.Mesh(Bulb.geometry, this.material);
			this.sphere.position.set(position.x, position.y, position.z);
		}

		get color() {
			return this.material.color;
		}

		set color(value) {
			this.material.color = value;
		}

		get object() {
			return this.sphere;
		}

		set bloom(value) {
		}
	}

	function setupScene(scene) {
		scene.children.length = 0;
		const coordinates = [
			{ x: 0.220093, y: 0.084900, z: 0.408569 },
			{ x: 0.261353, y: 0.116882, z: 0.554810 },
			{ x: 0.213257, y: 0.133789, z: 0.676758 },
			{ x: 0.247437, y: 0.176880, z: 0.801636 },
			{ x: 0.186157, y: 0.200378, z: 0.928589 },
			{ x: 0.076172, y: 0.208862, z: 1.000000 },
			{ x: -0.066406, y: 0.210938, z: 0.985718 },
			{ x: -0.208984, y: 0.212952, z: 0.971436 },
			{ x: -0.286133, y: 0.183411, z: 0.887451 },
			{ x: -0.385986, y: 0.194397, z: 0.788818 },
			{ x: -0.478271, y: 0.189392, z: 0.740845 },
			{ x: -0.614868, y: 0.170044, z: 0.661255 },
			{ x: -0.682861, y: 0.177185, z: 0.515503 },
			{ x: -0.777100, y: 0.197510, z: 0.440552 },
			{ x: -0.843506, y: 0.209473, z: 0.282349 },
			{ x: -0.784790, y: 0.203247, z: 0.157471 },
			{ x: -0.676514, y: 0.193481, z: 0.031860 },
			{ x: -0.634644, y: 0.200562, z: -0.060059 },
			{ x: -0.593506, y: 0.217041, z: -0.210449 },
			{ x: -0.656128, y: 0.245728, z: -0.324219 },
			{ x: -0.582397, y: 0.275635, z: -0.474854 },
			{ x: -0.541504, y: 0.282471, z: -0.581055 },
			{ x: -0.396606, y: 0.274353, z: -0.722656 },
			{ x: -0.290649, y: 0.267334, z: -1.000000 },
			{ x: -0.167969, y: 0.341614, z: -0.979370 },
			{ x: -0.168701, y: 0.406860, z: -0.970947 },
			{ x: -0.067383, y: 0.389954, z: -0.874268 },
			{ x: 0.033813, y: 0.373047, z: -0.777588 },
			{ x: 0.135132, y: 0.356079, z: -0.680908 },
			{ x: 0.255615, y: 0.294067, z: -0.693604 },
			{ x: 0.410034, y: 0.326965, z: -0.504761 },
			{ x: 0.431396, y: 0.300415, z: -0.355103 },
			{ x: 0.517212, y: 0.291443, z: -0.221558 },
			{ x: 0.616821, y: 0.314026, z: -0.116943 },
			{ x: 0.700806, y: 0.344299, z: -0.023071 },
			{ x: 0.739380, y: 0.374817, z: 0.073730 },
			{ x: 0.749023, y: 0.378784, z: 0.200806 },
			{ x: 0.702637, y: 0.395081, z: 0.348633 },
			{ x: 0.660889, y: 0.397949, z: 0.501587 },
			{ x: 0.530762, y: 0.380188, z: 0.510376 },
			{ x: 0.382324, y: 0.377258, z: 0.551880 },
			{ x: 0.238281, y: 0.357300, z: 0.597778 },
			{ x: 0.114014, y: 0.351440, z: 0.610596 },
			{ x: -0.016968, y: 0.328308, z: 0.649780 },
			{ x: -0.151855, y: 0.303589, z: 0.590942 },
			{ x: -0.292847, y: 0.287720, z: 0.613647 },
			{ x: -0.446655, y: 0.293701, z: 0.590576 },
			{ x: -0.564697, y: 0.324219, z: 0.590088 },
			{ x: -0.687256, y: 0.350830, z: 0.523315 },
			{ x: -0.784424, y: 0.374878, z: 0.477417 },
			{ x: -0.840454, y: 0.393433, z: 0.334717 },
			{ x: -0.769653, y: 0.371155, z: 0.270020 },
			{ x: -0.676392, y: 0.372437, z: 0.138184 },
			{ x: -0.619263, y: 0.366516, z: 0.013550 },
			{ x: -0.523438, y: 0.373169, z: -0.102173 },
			{ x: -0.518311, y: 0.430725, z: -0.194336 },
			{ x: -0.454712, y: 0.458008, z: -0.295044 },
			{ x: -0.391235, y: 0.485229, z: -0.395630 },
			{ x: -0.233154, y: 0.501404, z: -0.432617 },
			{ x: -0.067505, y: 0.485901, z: -0.559570 },
			{ x: 0.046509, y: 0.516418, z: -0.540527 },
			{ x: 0.198242, y: 0.530823, z: -0.568237 },
			{ x: 0.328491, y: 0.520935, z: -0.571289 },
			{ x: 0.220581, y: 0.488647, z: -0.534546 },
			{ x: 0.260254, y: 0.518188, z: -0.485718 },
			{ x: 0.358887, y: 0.506226, z: -0.365967 },
			{ x: 0.413452, y: 0.526733, z: -0.275757 },
			{ x: 0.456055, y: 0.520874, z: -0.230103 },
			{ x: 0.520874, y: 0.514893, z: -0.044678 },
			{ x: 0.490479, y: 0.480835, z: 0.070801 },
			{ x: 0.411255, y: 0.456848, z: 0.165405 },
			{ x: 0.364136, y: 0.479309, z: 0.279175 },
			{ x: 0.317139, y: 0.501770, z: 0.392822 },
			{ x: 0.222778, y: 0.503052, z: 0.498047 },
			{ x: 0.109253, y: 0.481689, z: 0.570312 },
			{ x: 0.001099, y: 0.465454, z: 0.587280 },
			{ x: -0.143066, y: 0.469788, z: 0.527344 },
			{ x: -0.271362, y: 0.495789, z: 0.536377 },
			{ x: -0.350342, y: 0.478271, z: 0.456909 },
			{ x: -0.427002, y: 0.485962, z: 0.333862 },
			{ x: -0.464355, y: 0.503784, z: 0.186523 },
			{ x: -0.468384, y: 0.511475, z: 0.061157 },
			{ x: -0.423462, y: 0.501160, z: -0.061157 },
			{ x: -0.273560, y: 0.498230, z: -0.058716 },
			{ x: -0.176758, y: 0.531128, z: -0.105957 },
			{ x: -0.058105, y: 0.567078, z: -0.047974 },
			{ x: 0.070557, y: 0.593872, z: -0.068726 },
			{ x: 0.048340, y: 0.619385, z: 0.008667 },
			{ x: -0.063477, y: 0.627502, z: 0.084595 },
			{ x: -0.060547, y: 0.643372, z: 0.026489 },
			{ x: 0.008057, y: 0.699219, z: 0.052979 },
			{ x: 0.052979, y: 0.739014, z: 0.074707 },
			{ x: -0.042969, y: 0.788147, z: 0.100830 },
			{ x: 0.005981, y: 0.839478, z: 0.101074 },
			{ x: -0.046509, y: 0.891174, z: 0.122070 },
			{ x: -0.057739, y: 0.937256, z: 0.111328 },
			{ x: -0.060181, y: 0.974976, z: 0.132812 },
			{ x: -0.074951, y: 0.997437, z: 0.145264 },
			{ x: -0.021484, y: 0.990356, z: 0.140747 },
			{ x: -0.018677, y: 1.000000, z: 0.160645 },
			{ x: 0.150757, y: 0.066956, z: 0.079590 },
			{ x: 0.144775, y: 0.116943, z: 0.052246 },
			{ x: 0.217896, y: 0.187683, z: -0.002686 },
			{ x: 0.321167, y: 0.197327, z: -0.154785 },
			{ x: 0.371826, y: 0.174622, z: -0.339844 },
			{ x: 0.478638, y: 0.183899, z: -0.463257 },
			{ x: 0.466064, y: 0.226257, z: -0.550415 },
			{ x: 0.415649, y: 0.191528, z: -0.740845 },
			{ x: 0.367920, y: 0.129700, z: -0.754883 },
			{ x: 0.196655, y: 0.098267, z: -0.671631 },
			{ x: 0.099121, y: 0.074646, z: -0.606812 },
			{ x: -0.003296, y: 0.024719, z: -0.512085 },
			{ x: -0.149048, y: 0.000000, z: -0.402954 },
			{ x: -0.238892, y: 0.009033, z: -0.302856 },
			{ x: -0.316040, y: 0.005310, z: -0.098999 },
			{ x: -0.439209, y: 0.005859, z: 0.016357 },
			{ x: -0.430786, y: 0.024719, z: 0.128418 },
			{ x: -0.484741, y: 0.034668, z: 0.324219 },
			{ x: -0.403198, y: 0.054749, z: 0.396362 },
			{ x: -0.284058, y: 0.052063, z: 0.521118 },
			{ x: -0.206909, y: 0.066650, z: 0.631592 },
			{ x: -0.068848, y: 0.068237, z: 0.706299 },
			{ x: -0.002930, y: 0.091858, z: 0.781616 },
			{ x: 0.135254, y: 0.117859, z: 0.866943 },
			{ x: 0.281860, y: 0.142090, z: 0.851318 },
			{ x: 0.430908, y: 0.143555, z: 0.830322 },
			{ x: 0.529053, y: 0.192566, z: 0.773560 },
			{ x: 0.573120, y: 0.187866, z: 0.629639 },
			{ x: 0.674438, y: 0.197510, z: 0.540527 },
			{ x: 0.766235, y: 0.202942, z: 0.472046 },
			{ x: 0.911255, y: 0.201355, z: 0.384766 },
			{ x: 0.866699, y: 0.210388, z: 0.245972 },
			{ x: 0.751953, y: 0.170654, z: 0.161377 },
			{ x: 0.711914, y: 0.151917, z: 0.066162 },
			{ x: 0.610596, y: 0.077576, z: -0.080078 },
			{ x: 0.550171, y: 0.084595, z: -0.168579 },
			{ x: 0.476074, y: 0.056458, z: -0.337158 },
			{ x: 0.369629, y: 0.045349, z: -0.504150 },
			{ x: 0.274414, y: 0.077576, z: -0.646729 },
			{ x: 0.141724, y: 0.086487, z: -0.669312 },
			{ x: -0.023315, y: 0.109619, z: -0.655273 },
			{ x: -0.188354, y: 0.132812, z: -0.641113 },
			{ x: -0.342896, y: 0.132935, z: -0.543091 },
			{ x: -0.465942, y: 0.165405, z: -0.457031 },
			{ x: -0.588501, y: 0.196350, z: -0.337402 },
			{ x: -0.726929, y: 0.213013, z: -0.227295 },
			{ x: -0.863770, y: 0.233704, z: -0.210205 },
			{ x: -1.000000, y: 0.221558, z: -0.232300 },
			{ x: -0.965210, y: 0.183105, z: -0.289673 },
			{ x: -0.869141, y: 0.203918, z: -0.183594 },
			{ x: -0.773071, y: 0.224792, z: -0.077637 },
			{ x: -0.770996, y: 0.304016, z: 0.058472 },
			{ x: -0.704224, y: 0.340698, z: 0.130859 },
			{ x: -0.605591, y: 0.381042, z: 0.200684 },
			{ x: -0.453247, y: 0.372375, z: 0.294312 },
			{ x: -0.335815, y: 0.346863, z: 0.338623 },
			{ x: -0.218384, y: 0.321350, z: 0.382812 },
			{ x: -0.133911, y: 0.333130, z: 0.492554 },
			{ x: -0.049561, y: 0.344910, z: 0.602173 },
			{ x: 0.038086, y: 0.312073, z: 0.628662 },
			{ x: 0.163940, y: 0.303162, z: 0.636230 },
			{ x: 0.268433, y: 0.287231, z: 0.564453 },
			{ x: 0.409790, y: 0.261841, z: 0.441406 },
			{ x: 0.508057, y: 0.252808, z: 0.366943 },
			{ x: 0.494995, y: 0.276428, z: 0.226807 },
			{ x: 0.488037, y: 0.282654, z: 0.065186 },
			{ x: 0.396851, y: 0.302917, z: -0.021240 },
			{ x: 0.276855, y: 0.315430, z: -0.100464 },
			{ x: 0.152100, y: 0.325439, z: -0.111328 },
			{ x: 0.014038, y: 0.300049, z: -0.105957 },
			{ x: -0.153320, y: 0.312744, z: -0.116699 },
			{ x: -0.148071, y: 0.326416, z: -0.236816 },
			{ x: -0.031494, y: 0.345093, z: -0.102539 },
			{ x: -0.076660, y: 0.337463, z: 0.049316 },
			{ x: -0.311523, y: 0.308105, z: -0.114624 },
			{ x: -0.253906, y: 0.343323, z: -0.232544 },
			{ x: -0.095459, y: 0.320557, z: -0.171997 },
			{ x: -0.109985, y: 0.302795, z: -0.028931 },
			{ x: -0.091919, y: 0.305603, z: 0.106079 },
			{ x: -0.013672, y: 0.306091, z: 0.258667 },
			{ x: 0.039062, y: 0.308411, z: 0.370728 },
			{ x: 0.073120, y: 0.338623, z: 0.515991 },
			{ x: 0.112549, y: 0.322571, z: 0.638672 },
			{ x: 0.152100, y: 0.306519, z: 0.761353 },
			{ x: 0.191528, y: 0.290466, z: 0.884033 },
			{ x: 0.306030, y: 0.325439, z: 0.954834 },
			{ x: 0.414062, y: 0.337280, z: 0.956421 },
			{ x: 0.515503, y: 0.339294, z: 0.898438 },
			{ x: 0.629639, y: 0.334900, z: 0.815552 },
			{ x: 0.757080, y: 0.324829, z: 0.688843 },
			{ x: 0.783691, y: 0.308594, z: 0.604614 },
			{ x: 0.821533, y: 0.329041, z: 0.493774 },
			{ x: 0.768677, y: 0.312622, z: 0.264526 },
			{ x: 0.886108, y: 0.305969, z: 0.181396 },
			{ x: 0.922607, y: 0.337280, z: 0.047119 },
			{ x: 0.921021, y: 0.343994, z: -0.102295 },
			{ x: 0.919434, y: 0.350769, z: -0.251587 },
			{ x: 1.000000, y: 0.365356, z: -0.281006 },
			{ x: 1.000000, y: 0.365356, z: -0.281006 },
			{ x: 1.000000, y: 0.365356, z: -0.281006 },
		];

		for (let i = 0; i < coordinates.length; i++) {
			const position = new THREE.Vector3(coordinates[i].x, coordinates[i].y, coordinates[i].z);
			position.y *= 2;
			let bulb = new Bulb(position);
			scene.add(bulb.object);
			bulb.bloom = Math.random() < 0.6;
		}
	}

	let main = new Main();
	main.init();
	window.onresize = () => main.onResize();
	window.addEventListener('pointerdown', (event) => main.onPointerDown(event));
	main.render();
</script>
</body>
</html>
